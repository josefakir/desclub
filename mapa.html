<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<title>Mapa - Desclub</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<link rel="stylesheet" href="css/template.css">
	<link rel="stylesheet" href="css/jquery.mobile.structure-1.4.5.css">
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="css/font-awesome.min.css">
	<link href='https://fonts.googleapis.com/css?family=Khula:400,300,600,700,800' rel='stylesheet' type='text/css'>
	<script src="js/jquery-1.11.3.min.js"></script>
	<script src="js/jquery.mobile-1.4.5.min.js"></script>
	<script src="http://maps.google.com/maps/api/js"></script>
	<script src="js/main.js"></script>
	<script>
	$(document).ready(function(){
		 var defaultLatLng = new google.maps.LatLng(34.0983425, -118.3267434);  
	    if ( navigator.geolocation ) {
	        function success(pos) {
	            drawMap(new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude),pos.coords.latitude,pos.coords.longitude);
	        }
	        function fail(error) {
	            drawMap(defaultLatLng);  
	        }
	        navigator.geolocation.getCurrentPosition(success, fail, {maximumAge: 500000, enableHighAccuracy:true, timeout: 6000});
	    } else {
	        drawMap(defaultLatLng); 
	    }
	    function drawMap(latlng,lat,lng) {
	        var myOptions = {
	            zoom: 17,
	            center: latlng,
	            mapTypeId: google.maps.MapTypeId.ROADMAP,
	            mapTypeControl: false
	        };
	        var map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);
	        // Add an overlay to the map of current lat/lng
	       
	        var marker = new google.maps.Marker({
	            position: latlng,
	            map: map,
	            title: "Greetings!"
	        });
			$.ajax({
	    		beforeSend : function(){
					$('.ui-loader').fadeIn('fast');
				},
				url : 'http://grupomedios.com/intranet/wsdesclub/?m=descuentos2&o=0&l=10&lat='+lat+'&long='+lng,
				success : function(result){
					r = result.Descuentos;
					$.each(r, function(index) {
						console.log(r[index].Marca);
						imgmarcador = r[index].categoria;
						imgmarcador = imgmarcador.replace(" ", "_");
						imgmarcador = imgmarcador.replace(" ", "_");
						imgmarcador = "images/"+imgmarcador+".png";
						calle = r[index].Calle;
		 				noext = r[index].Numero_Extterior;
		 				noint = r[index].Numero_interior;
		 				colonia = r[index].Colonia;
						var contentString = '<div class="tooltipmapa"><img class="imagenmapa" src="'+r[index].logo_chico+'"/><h2>'+r[index].Sucursal+'</h2><p class="direccionmapa">'+calle+' '+noint+' '+noext+' '+colonia+'</p></div>';
						var infowindow = new google.maps.InfoWindow({
						    content: contentString
						});
						marker = new google.maps.Marker({
					        position: new google.maps.LatLng(r[index].Latitud, r[index].Longitud),
					        map: map,
					        icon: imgmarcador
					    });
					    marker.addListener('click', function() {
    						infowindow.open(map, marker);
  						});
					});
					$('.ui-loader').fadeOut('fast');

				}
			});



	    }
	    function drawMarkers(lat,lng){
	    	
	    }
	});
	</script>
</head>
<body>
<div data-role="page" id="map-page">
    <div role="main" class="ui-content" id="map-canvas">
        <!-- map loads here... -->
    </div>
    <div id="footer">
		<ul id="menufooter" data-role="footer" data-position="fixed">
			<li><a href="index.html" data-transition="flip" data-ajax="false" ><i class="fa fa-home"></i></a><br><span class="spanfooter">Inicio</span></li>
			<li><a href="mapa.html" data-transition="flip"  data-ajax="false" ><i class="fa fa-map-marker"></i></a><br><span class="spanfooter">Mapa</span></li>
			<li><a href="recomendados.html" data-transition="flip"><i class="fa fa-heart-o"></i></a><br><span class="spanfooter">Recomendados</span></li>
			<li><a href="tarjeta.html" data-transition="flip"><i class="fa fa-credit-card"></i></a><br><span class="spanfooter">Tarjeta</span></li>
		</ul>
	</div>
</div>
</body>
</html>